name: Sync Deployment Branches

on:
  push:
    branches:
      - main  # Only sync when production code is updated
  workflow_dispatch:

jobs:
  sync-branches:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    
    strategy:
      fail-fast: false
      matrix:
        branch:
          - deploy/zeabur
          - deploy/docker
          - deploy/claude-desktop
          - deploy/remote-sse
          - deploy/railway
          
    steps:
      - name: Checkout main
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
          persist-credentials: true
          
      - name: Configure Git
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          
      - name: Sync ${{ matrix.branch }}
        run: |
          # Fetch all branches
          git fetch origin
          
          # Check if branch exists on remote
          if git ls-remote --heads origin | grep -q "refs/heads/${{ matrix.branch }}"; then
            echo "Syncing existing branch: ${{ matrix.branch }}"
            
            # Checkout the deployment branch
            git checkout -B ${{ matrix.branch }} origin/${{ matrix.branch }}
            
            # Merge main while preserving deployment files
            git merge main --no-edit --strategy-option=ours \
              || (git add -A && git commit -m "Merge main into ${{ matrix.branch }}")
            
            # Push changes
            git push origin ${{ matrix.branch }}
          else
            echo "Creating new branch: ${{ matrix.branch }}"
            
            # Create new branch from main
            git checkout -b ${{ matrix.branch }}
            
            # Create deployment directory if needed
            deployment_name=$(echo "${{ matrix.branch }}" | sed 's|deploy/||')
            mkdir -p "deploy/${deployment_name}"
            echo "# ${deployment_name} Deployment Configuration" > "deploy/${deployment_name}/README.md"
            echo "" >> "deploy/${deployment_name}/README.md"
            echo "This directory contains deployment-specific configurations for ${deployment_name}." >> "deploy/${deployment_name}/README.md"
            
            # Only commit if there are changes
            if git diff --staged --quiet; then
              git add -A
              if ! git diff --staged --quiet; then
                git commit -m "Initial deployment setup for ${{ matrix.branch }}"
              fi
            fi
            
            # Push new branch
            git push -u origin ${{ matrix.branch }}
          fi
          
      - name: Return to main
        if: always()
        run: git checkout main